!function(){function e(e){var t=$("#select_project_id")[0].selectize.items[0];$.ajax({url:"/api/v1.0/projects/"+t,type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){$("#margin").val(100*e.margin+"%");var t=$("#admin-fee");null===e.admin_fee?(t.parents(".form-group").hide(),t.val("")):(t.parents(".form-group").show(),t.val(accounting.formatMoney(e.admin_fee))),a()})}function t(e){return!isNaN(parseFloat(e))&&isFinite(e)}function a(){var e=0;$(".input-amount").each(function(a,n){var o=$(n).val();""!==o&&t(o)&&(e+=parseFloat(o))}),$("#value-of-work").val(accounting.formatMoney(e));var a=0;a+=e*(1+parseFloat($("#margin").val())/100);var n=$("#admin-fee").val();""!==n&&(a+=accounting.parse(n)),$("#subtotal").val(accounting.formatMoney(a))}function n(e){var t=$('<tr class="variationItem"><td><textarea name="description" class="input-desc form-control" required></textarea></td><td style="vertical-align:middle;"><input type="text" name="amount" class="input-amount form-control" required data-parsley-type="number" oninput="update()"/></td><td style="width:150px;text-align:center;vertical-align:middle;"><a href="javascript:void(0)" class="add-row" onclick="addRow();"><i class="fa fa-plus"></i> Add</a> / <a href="javascript:void(0)" class="delete-row" onclick="deleteRow(this);"><i class="fa fa-minus"></i> Delete</a></td></tr>');$("#items").append(t)}function o(e){var t=e.parentNode.parentNode;t.parentNode.removeChild(t),a()}var i=$("#meta-data").data(),c=i.newProjectUrl,r=i.newVariationUrl,l=i.newItemUrl;$(function(){$.material.init(),$("#picker_datetime").datetimepicker({showTodayButton:!0}),$("#form-new-project").parsley(),$("#form-new-variation").parsley()}),$(document).ready(function(){$("#select_project_id").selectize({sortField:"text"}),$("#btn-add-project").on("click",function(e){var t=$("#form-new-project").parsley();if(t.validate(),t.isValid()){var a=$("#extra_project_name").val(),n=$("#extra_margin").val(),o=$("#extra_reference_number").val(),i=$("#extra_admin_fee").val();""===i&&(i=null);var r=this;swal({title:"Are you sure to add the project?",text:"You can recover this project later!",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, add it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(e){if(!e)return void swal("Cancelled","The project file is safe :)","error");var t=$(r),l=t.html();t.html('<i class="fa fa-spinner fa-spin"></i> '+l),t.off("click"),$.ajax({url:c,type:"POST",data:JSON.stringify({name:a,margin:n,reference_number:o,admin_fee:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){swal({title:"Nice!",text:"You created a new project: "+e.name,type:"success"},function(){location.reload()})})})}}),$("#btn_submit").on("click",function(e){var t=$("#form-new-variation").parsley();if(t.validate(),t.isValid()){var a=$("#select_project_id")[0].selectize.items[0],n=$("#picker_datetime").data("DateTimePicker").date(),o=n.utc().format(),i=$("#input_subcontractor").val(),c=$("#input_invoice_no").val(),s=accounting.unformat($("#subtotal").val()),d=$("#input_description").val(),p=this;swal({title:"Are you sure?",text:"Time: "+n.format("Do MMMM YYYY h:mm:ss a")+"\nSubcontractor: "+i+"\nAmount: "+accounting.formatMoney(s),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, add it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(e){if(!e)return void swal("Cancelled","Your imaginary file is safe :)","error");var t=$(p),n=t.html();t.html('<i class="fa fa-spinner fa-spin"></i> '+n),t.off("click"),$.ajax({url:r,type:"POST",data:JSON.stringify({project_id:a,date:o,subcontractor:i,invoice_no:c,amount:s,description:d}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){var t=e.vid,a=!0;$(".variationItem").each(function(e,a){var n=$(a.children[0].children[0]).val(),o=$(a.children[1].children[0]).val();""!==n&&""!==o&&$.ajax({url:l,type:"POST",data:JSON.stringify({variation_id:t,description:n,amount:o}),contentType:"application/json; charset=utf-8",dataType:"json"})}),a&&swal({title:"Nice!",text:"You created a new variation",type:"success"},function(){location.reload()})})})}}),$(".input-amount").on("change",a)})}(),function(){function e(e){var t=$(e).parents("tr");t.attr("class","info"),t.find(".checkbox-approved").prop("checked",!1),t.find(".checkbox-declined").prop("checked",!1),$("#btn-save").prop("disabled",!1)}function t(e,t,a){var n;return n=e?'<input class="checkbox checkbox-pending" type="checkbox" checked="" onclick="pendingClick(this);">':'<input class="checkbox checkbox-pending" type="checkbox" onclick="pendingClick(this);">',"<label>"+n+"</label>"}function a(e){var t=$(e).parents("tr");t.attr("class","success"),t.find(".checkbox-pending").prop("checked",!1),t.find(".checkbox-declined").prop("checked",!1),$("#btn-save").prop("disabled",!1)}function n(e,t,a){var n;return n=e?'<input class="checkbox checkbox-approved" type="checkbox" checked="" onclick="approvedClick(this);">':'<input class="checkbox checkbox-approved" type="checkbox" onclick="approvedClick(this);">',"<label>"+n+"</label>"}function o(e){var t=$(e).parents("tr");t.attr("class","danger"),t.find(".checkbox-pending").prop("checked",!1),t.find(".checkbox-approved").prop("checked",!1),$("#btn-save").prop("disabled",!1)}function i(e,t,a){var n;return n=e?'<input class="checkbox checkbox-declined" type="checkbox" checked="" onclick="declinedClick(this);">':'<input class="checkbox checkbox-declined" type="checkbox" onclick="declinedClick(this);">',"<label>"+n+"</label>"}function c(e){$("#btn-save").prop("disabled",!1)}function r(e,t,a){var n;return n=e?'<input class="checkbox checkbox-complete" type="checkbox" checked="" onclick="completeClick(this);">':'<input class="checkbox checkbox-complete" type="checkbox" onclick="completeClick(this);">',"<label>"+n+"</label>"}function l(e,t){return e.pending?{classes:"info"}:e.approved?{classes:"success"}:e.declined?{classes:"danger"}:{classes:"active"}}function s(e,t,a){return"<p>"+moment(e).toDate()+"</p>"}function d(e,t,a){return accounting.formatMoney(e)}function p(e){return null===e||""===e?"Cannot be empty!":void 0}function u(e,t){var a="/api/v1.0/variations/"+t.vid+"/items/",n=this;return setTimeout(function(){$.ajax({url:a,type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){for(var a=t.items,o='<table class="table table-hover"><thead><tr><th style="text-align: center">Name</th><th style="text-align: center">Amount</th></tr></thead><tbody>',i="new-editable-description-"+e,c="new-editable-amount-"+e,r=0;r<a.length;++r){var l=a[r],s=l.id,d='<a href="javascript:void(0)" data-type="textarea" pk='+s+' class="'+i+'">'+l.description+"</a>",p='<a href="javascript:void(0)" data-type="textarea" pk='+s+' class="'+c+'">'+l.amount+"</a>";o+='<tr class="item-detail"><td>'+d+'</td><td style="text-align: right;width: 200px">'+p+"</td></tr>"}o+="</tbody></table>",$($("[data-index="+e+"]").next()).children().html(o),$("."+i).editable(),$("."+c).editable(),$("."+i).on("save",function(e,t){$("#btn-save").prop("disabled",!1)}),$("."+c).on("save",function(e,t){$("#btn-save").prop("disabled",!1);var a=0;$("."+c).each(function(n,o){if(o!==e.target){var i=$(o).html();""!==i&&isNumeric(i)&&(a+=parseFloat(i))}else a+=parseFloat(t.newValue)}),a*=1+k,""!==y&&(a+=y),$(n).closest(".detail-view").prev().children(".subtotal").html("<b>"+accounting.formatMoney(a)+"</b>")})})},0),'<strong><i class="fa fa-spinner fa-spin"></i> Loading...</strong>'}var f=$("#project-data").data(),h=f.deleteProjectUrl,m=f.editProjectUrl,v=f.getProjectVariationsUrl,b=f.projectActive,y=f.projectAdminFee,x=f.projectId,k=f.projectMargin,g=f.projectName;$.ajax({url:v,type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(e){$("#table").bootstrapTable({columns:[{checkbox:!0},{field:"virtual_id",title:"#",halign:"center",sortable:!0},{field:"description",title:"Description",editable:{type:"textarea"},halign:"center",width:"600px"},{field:"date",title:"Date",formatter:"timeFormatter",halign:"center",width:"300px"},{field:"subcontractor",title:"Subcontractor",editable:{type:"text",validate:p},halign:"center",sortable:!0},{field:"amount",title:"Subtotal ($)",halign:"center",sortable:!0,formatter:"moneyFormatter","class":"subtotal"},{field:"invoice_no",title:"Invoice #",editable:!0,halign:"center"},{field:"note",title:"Note",editable:{type:"textarea"},halign:"center"},{field:"pending",title:"Pending",formatter:"pendingFormatter",halign:"center",valign:"center",sortable:!0,"class":"pending"},{field:"approved",title:"Approved",formatter:"approvedFormatter",halign:"center",valign:"center",sortable:!0,"class":"approved"},{field:"declined",title:"Declined",formatter:"declinedFormatter",halign:"center",valign:"center",sortable:!0,"class":"declined"},{field:"completed",title:"Completed",formatter:"completeFormatter",halign:"center",valign:"center",sortable:!0,"class":"completed"}],data:e.variations,rowStyle:"rowStyle",toolbar:"#toolbar",detailView:!0,detailFormatter:"detailFormatter"})}).always(function(){$("body").addClass("loaded")}),$.fn.editable.defaults.mode="inline",$(document).ready(function(){$("#delete_project").on("click",function(e){var t=this;swal({title:"Are you sure to delete the project?",text:"You are going to",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(e){if(!e)return void swal("Cancelled","Your project is safe :)","error");var a=$(t),n=a.html();a.html('<i class="fa fa-spinner fa-spin"></i> '+n),a.off("click"),$.ajax({url:h,type:"DELETE",contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(){swal({title:"Nice!",text:"You delete: {{ current_project.name }}",type:"success"},function(){window.location.href="/"})})})}),$("#archive_project").on("click",function(e){var t="archive",a=this;swal({title:"Are you sure to "+t+" the project?",text:"You can recover this project later!",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, "+t+" it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(e){if(!e)return void swal("Cancelled","The project file is safe :)","error");var n=$(a),o=n.html();n.html('<i class="fa fa-spinner fa-spin"></i> '+o),n.off("click");var i=null;i="True"===b?!1:!0,$.ajax({url:m,type:"PUT",data:JSON.stringify({active:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(){swal({title:"Nice!",text:"You "+t+": {{ current_project.name }}",type:"success"},function(){location.reload()})})})}),$("#btn-save-meta").on("click",function(e){var t=$("#edit-project-meta-form").parsley();t.validate();var a=this;t.isValid()&&swal({title:"Are you sure to save the changes?",text:"You cannot recover them later!",type:"warning",showCancelButton:!0,confirmButtonColor:"teal",confirmButtonText:"Yes, save them!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(e){if(!e)return void swal("Cancelled","Your project is safe :)","error");var t=$(a),n=t.html();t.html('<i class="fa fa-spinner fa-spin"></i> '+n),t.off("click");var o=$("#new_name").val(),i=$("#new_margin").val(),c=$("#new_ref_number").val(),r=$("#new_admin_fee").val();""===r&&(r=null),$.ajax({url:m,type:"PUT",data:JSON.stringify({name:o,margin:i,admin_fee:r,reference_number:c}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(){swal({title:"Nice!",text:"Save changes",type:"success"},function(){location.reload()})})})});var e=$("#table");e.on("editable-save.bs.table",function(e){$("#btn-save").prop("disabled",!1)}),e.on("check.bs.table check-all.bs.table check-some.bs.table",function(e){$("#btn-delete").prop("disabled",!1)}),e.on("uncheck-all.bs.table",function(e){$("#btn-delete").prop("disabled",!0)}),e.on("uncheck.bs.table	uncheck-some.bs.table",function(t){var a=e.bootstrapTable("getSelections");0==a&&$("#btn-delete").prop("disabled",!0)}),$("#btn-delete").on("click",function(t){var a=this;swal({title:"Are you sure to delete selected rows?",text:"You cannot recover them later!",type:"warning",showCancelButton:!0,confirmButtonColor:"teal",confirmButtonText:"Yes, save them!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(t){if(!t)return void swal("Cancelled","Your project is safe :)","error");var n=$(a),o=n.html();n.html('<i class="fa fa-spinner fa-spin"></i> '+o),n.off("click");for(var i=!0,c=e.bootstrapTable("getSelections"),r=0;r<c.length;++r)$.ajax({url:"/api/v1.0/variations/"+c[r].vid,type:"DELETE",contentType:"application/json; charset=utf-8",dataType:"json"}).fail(function(){i=!1});i&&swal({title:"Nice!",text:"Delete variations",type:"success"},function(){location.reload()})})}),$("#btn-save").on("click",function(t){var a=this;swal({title:"Are you sure to save all the changes?",type:"info",showCancelButton:!0,confirmButtonColor:"teal",confirmButtonText:"Yes, save them!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1},function(t){if(!t)return void swal("Cancelled","Your saves are unsaved","error");var n=$(a),o=n.html();n.html('<i class="fa fa-spinner fa-spin"></i> '+o),n.off("click");for(var i=e.bootstrapTable("getData"),c=0;c<i.length;++c){var r=i[c],l=r.vid,s="[data-index="+c+"]",d=$(s);r.pending=d.find(".pending").children().children().is(":checked"),r.approved=d.find(".approved").children().children().is(":checked"),r.declined=d.find(".declined").children().children().is(":checked"),r.completed=d.find(".completed").children().children().is(":checked"),r.amount=accounting.parse(d.find(".subtotal").html()),$.ajax({url:"/api/v1.0/variations/"+l,type:"PUT",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",dataType:"json"})}$(".item-detail").each(function(e,t){var a=$(t).find("a"),n=$(a[0]),o=$(a[1]),i=n.attr("pk"),c=n.html(),r=parseFloat(o.html());$.ajax({url:"/api/v1.0/items/"+i,type:"PUT",data:JSON.stringify({amount:r,description:c}),contentType:"application/json; charset=utf-8",dataType:"json"})}),swal({title:"Nice!",text:"You saved all changes.",type:"success"},function(){location.reload()})})})})}();