!function(){function t(t){var e=$("#select_project_id")[0].selectize.items[0];$.ajax({url:"/api/v1.0/projects/"+e,type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){$("#margin").val(100*t.margin+"%");var e=$("#admin-fee");null===t.admin_fee?(e.parents(".form-group").hide(),e.val("")):(e.parents(".form-group").show(),e.val(accounting.formatMoney(t.admin_fee))),a()})}function e(t){return!isNaN(parseFloat(t))&&isFinite(t)}function a(){var t=0;$(".input-amount").each(function(a,n){var i=$(n).val();""!==i&&e(i)&&(t+=parseFloat(i))}),$("#value-of-work").val(accounting.formatMoney(t));var a=0;a+=t*(1+parseFloat($("#margin").val())/100);var n=$("#admin-fee").val();""!==n&&(a+=accounting.parse(n)),$("#subtotal").val(accounting.formatMoney(a))}function n(t){var e=$('<tr class="variationItem"><td><textarea name="description" class="input-desc form-control" required></textarea></td><td style="vertical-align:middle;"><input type="text" name="amount" class="input-amount form-control" required data-parsley-type="number" oninput="update()"/></td><td style="width:150px;text-align:center;vertical-align:middle;"><a href="javascript:void(0)" class="add-row" onclick="addRow();"><i class="fa fa-plus"></i> Add</a> / <a href="javascript:void(0)" class="delete-row" onclick="deleteRow(this);"><i class="fa fa-minus"></i> Delete</a></td></tr>');$("#items").append(e)}function i(t){var e=t.parentNode.parentNode;e.parentNode.removeChild(e),a()}var o=$("#meta-data").data(),r=o.newProjectUrl,c=o.newVariationUrl,l=o.newItemUrl;$(function(){$.material.init(),$("#picker_datetime").datetimepicker({showTodayButton:!0}),$("#form-new-project").parsley(),$("#form-new-variation").parsley()}),$(document).ready(function(){$("#select_project_id").selectize({sortField:"text"}),$("#btn-add-project").on("click",function(t){var e=$("#form-new-project").parsley();if(e.validate(),e.isValid()){var a=$("#extra_project_name").val(),n=$("#extra_margin").val(),i=$("#extra_reference_number").val(),o=$("#extra_admin_fee").val();""===o&&(o=null),swal({title:"Are you sure to add the project?",text:"You can recover this project later!",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, add it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1,customClass:"newProjectConfirmation"},function(t){if(!t)return void swal("Cancelled","The project file is safe :)","error");var e=$(".newProjectConfirmation").find(".confirm"),c=e.html();e.html('<i class="fa fa-spinner fa-spin"></i> '+c),e.off("click"),$.ajax({url:r,type:"POST",data:JSON.stringify({name:a,margin:n,reference_number:i,admin_fee:o}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){swal({title:"Nice!",text:"You created a new project: "+t.name,type:"success"},function(){location.reload()})})})}}),$("#btn_submit").on("click",function(t){var e=$("#form-new-variation").parsley();if(e.validate(),e.isValid()){var a=$("#select_project_id")[0].selectize.items[0],n=$("#picker_datetime").data("DateTimePicker").date(),i=n.utc().format(),o=$("#input_subcontractor").val(),r=$("#input_invoice_no").val(),s=accounting.unformat($("#subtotal").val()),d=$("#input_description").val();swal({title:"Are you sure?",text:"Time: "+n.format("Do MMMM YYYY h:mm:ss a")+"\nSubcontractor: "+o+"\nAmount: "+accounting.formatMoney(s),type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, add it!",cancelButtonText:"No, cancel plx!",closeOnConfirm:!1,closeOnCancel:!1,customClass:"newVariationConfirmation"},function(t){if(!t)return void swal("Cancelled","Your imaginary file is safe :)","error");var e=$(".newVariationConfirmation").find(".confirm"),n=e.html();e.html('<i class="fa fa-spinner fa-spin"></i> '+n),e.off("click"),$.ajax({url:c,type:"POST",data:JSON.stringify({project_id:a,date:i,subcontractor:o,invoice_no:r,amount:s,description:d}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(t){var e=t.vid,a=!0;$(".variationItem").each(function(t,a){var n=$(a.children[0].children[0]).val(),i=$(a.children[1].children[0]).val();""!==n&&""!==i&&$.ajax({url:l,type:"POST",data:JSON.stringify({variation_id:e,description:n,amount:i}),contentType:"application/json; charset=utf-8",dataType:"json"})}),a&&swal({title:"Nice!",text:"You created a new variation",type:"success"},function(){location.reload()})})})}}),$(".input-amount").on("change",a)})}();